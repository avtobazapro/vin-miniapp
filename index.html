<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Расшифровка VIN</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#fff;--text:#111;--hint:#6b7280;--card:#f3f4f6;--border:rgba(0,0,0,.1);--accent:#2d7df6;--accentText:#fff;--danger:#ef4444;}
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto}
    h1{font-size:36px;line-height:1.05;margin:8px 0 14px}
    .row{display:flex;gap:10px;align-items:center}
    input{flex:1;min-width:0;padding:14px 14px;border:2px solid var(--border);border-radius:16px;font-size:18px;background:transparent;color:var(--text);outline:none}
    button{padding:14px 16px;border:0;border-radius:16px;font-size:18px;cursor:pointer;background:var(--accent);color:var(--accentText);font-weight:700;white-space:nowrap}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:10px;font-size:15px;display:none}
    .msg.err{color:var(--danger)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px;margin-top:14px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td{padding:12px 6px;border-top:1px solid var(--border);vertical-align:top}
    td.k{color:var(--hint);width:40%}
    td.v{font-weight:700;word-break:break-word;overflow-wrap:anywhere}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Расшифровка VIN</h1>

    <div class="row">
      <input id="inp" placeholder="VIN или ссылка" autocomplete="off"/>
      <button id="btn">Проверить</button>
    </div>

    <div id="msgErr" class="msg err"></div>
    <div id="result"></div>
  </div>

<script>
  // ВАЖНО: URL твоего Worker (backend)
  const API_BASE = "https://vin-access.nikolay-nee.workers.dev"; // <-- твой домен Worker

  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const inp = document.getElementById('inp');
  const btn = document.getElementById('btn');
  const msgErr = document.getElementById('msgErr');
  const result = document.getElementById('result');

  function showErr(t){ msgErr.style.display=t?'block':'none'; msgErr.textContent=t||''; }
  function setLoading(on){ btn.disabled=on; btn.textContent=on?'Проверяю…':'Проверить'; }
  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  function row(k,v){
    if (v === null || v === undefined || v === '' || v === 'Not Applicable') return '';
    return `<tr><td class="k">${esc(k)}</td><td class="v">${esc(v)}</td></tr>`;
  }

  function render(d){
    result.innerHTML = `
      <div class="card">
        <table>
          ${row('VIN', d.vin)}
          ${row('Ссылка', d.link)}
          ${row('Марка', d.make)}
          ${row('Модель', d.model)}
          ${row('Дата производства', d.productionDate)}
          ${row('Тип ТС', d.vehicleType)}
          ${row('Кузов', d.bodyClass)}
          ${row('Двигатель', d.engine)}
          ${row('Коробка', d.transmission)}
          ${row('Страна сборки', d.plantCountry)}
          ${row('Завод', d.plantCompany)}
          ${row('Предупреждение', d.errorText)}
          ${row('Рекомендуемый VIN (по версии NHTSA)', d.suggestedVin)}
          ${row('Возможные значения', d.possibleValues)}
        </table>

        <div class="actions">
          <button class="secondary" id="pdfBtn">Скачать PDF</button>
        </div>
      </div>
    `;
    document.getElementById('pdfBtn').onclick = () => makePdf(d);
  }

  function makePdf(d){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    let y = 50;

    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('avtobaza.pro', 40, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(12);
    doc.text('Расшифровка VIN', 40, y+18);

    y += 34; doc.setDrawColor(200); doc.line(40, y, 555, y); y += 24;

    const rows = [
      ['VIN', d.vin],
      d.link ? ['Ссылка', d.link] : null,
      ['Марка', d.make || '—'],
      ['Модель', d.model || '—'],
      ['Дата производства', d.productionDate || 'нет данных'],
      ['Тип ТС', d.vehicleType || '—'],
      d.bodyClass ? ['Кузов', d.bodyClass] : null,
      d.engine ? ['Двигатель', d.engine] : null,
      d.transmission ? ['Коробка', d.transmission] : null,
      d.plantCountry ? ['Страна сборки', d.plantCountry] : null,
      d.plantCompany ? ['Завод', d.plantCompany] : null,
      d.errorText ? ['Предупреждение', d.errorText] : null,
      d.suggestedVin ? ['Рекомендуемый VIN', d.suggestedVin] : null,
      d.possibleValues ? ['Возможные значения', d.possibleValues] : null,
    ].filter(Boolean);

    doc.setFontSize(11);
    for (const [k,v] of rows){
      doc.setFont('helvetica','bold'); doc.text(k + ':', 40, y);
      doc.setFont('helvetica','normal');
      const wrapped = doc.splitTextToSize(String(v), 360);
      doc.text(wrapped, 210, y);
      y += 18 + (wrapped.length-1)*14;
      if (y > 770){ doc.addPage(); y = 60; }
    }

    doc.save('VIN_' + (d.vin||'report') + '.pdf');
  }

  async function doSearch(){
    showErr('');
    result.innerHTML = '';

    const input = (inp.value||'').trim();
    if (!input){ showErr('Введите VIN или ссылку'); return; }

    const initData = tg?.initData || '';
    if (!initData){ showErr('Откройте мини-приложение внутри Telegram'); return; }

    setLoading(true);
    try{
      const r = await fetch(API_BASE + "/decode", {
        method:'POST',
        headers:{ 'content-type':'application/json' },
        body: JSON.stringify({ input, initData })
      });

      const text = await r.text();
      let j = null;
      try { j = JSON.parse(text); } catch {}

      if (!j || !j.ok){
        showErr(j?.error || ('Ошибка сервера: ' + r.status));
        return;
      }

      render(j.data);
    }catch(e){
      showErr('Ошибка сети/сервера. Проверь Worker URL.');
    }finally{
      setLoading(false);
    }
  }

  btn.addEventListener('click', doSearch);
  inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });
</script>
</body>
</html>
